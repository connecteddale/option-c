---
phase: 01-foundation-menu-bar
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Sources/OptionC/State/AppState.swift
  - Sources/OptionC/Views/MenuBarView.swift
  - Sources/OptionC/KeyboardShortcuts+Names.swift
  - Sources/OptionC/OptionCApp.swift
autonomous: true

must_haves:
  truths:
    - "Pressing Option-C changes icon from mic.circle to mic.circle.fill"
    - "Menu dropdown shows current recording mode (Toggle or Push-to-Talk)"
    - "User can switch recording mode via radio group in menu"
    - "User can quit app via Quit button in menu"
  artifacts:
    - path: "Sources/OptionC/KeyboardShortcuts+Names.swift"
      provides: "Global hotkey name registration"
      contains: "toggleRecording"
    - path: "Sources/OptionC/Views/MenuBarView.swift"
      provides: "Menu content with mode picker and quit button"
      contains: "RecordingMode"
    - path: "Sources/OptionC/State/AppState.swift"
      provides: "Hotkey handler and state transitions"
      contains: "KeyboardShortcuts.onKeyUp"
  key_links:
    - from: "AppState.swift"
      to: "KeyboardShortcuts"
      via: "onKeyUp handler registration"
      pattern: "KeyboardShortcuts\\.onKeyUp"
    - from: "MenuBarView.swift"
      to: "AppState.recordingMode"
      via: "Picker binding"
      pattern: "\\$appState\\.recordingMode"
    - from: "OptionCApp.swift"
      to: "MenuBarView.swift"
      via: "MenuBarExtra content"
      pattern: "MenuBarView"
---

<objective>
Implement Option-C hotkey detection, state transitions, and menu content with mode switching.

Purpose: Complete the user-facing functionality of Phase 1 - users can press Option-C to trigger state changes, see mode options in menu, and quit the app.

Output: Fully functional menu bar app responding to Option-C with visual feedback and user controls.
</objective>

<execution_context>
@/Users/connecteddale/.claude/get-shit-done/workflows/execute-plan.md
@/Users/connecteddale/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-menu-bar/01-RESEARCH.md
@.planning/phases/01-foundation-menu-bar/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KeyboardShortcuts Integration</name>
  <files>
    Sources/OptionC/KeyboardShortcuts+Names.swift
    Sources/OptionC/State/AppState.swift
  </files>
  <action>
    Implement global hotkey registration with Option-C shortcut:

    1. **Sources/OptionC/KeyboardShortcuts+Names.swift**: Create extension file:
       ```swift
       import KeyboardShortcuts

       extension KeyboardShortcuts.Name {
           static let toggleRecording = Self("toggleRecording", default: .init(.c, modifiers: [.option]))
       }
       ```

    2. **Sources/OptionC/State/AppState.swift**: Update to add hotkey handler in init():
       ```swift
       import KeyboardShortcuts

       @MainActor
       class AppState: ObservableObject {
           @Published var currentState: RecordingState = .idle
           @AppStorage("recordingMode") var recordingMode: RecordingMode = .toggle

           init() {
               KeyboardShortcuts.onKeyUp(for: .toggleRecording) { [weak self] in
                   self?.handleHotkeyPress()
               }
           }

           func handleHotkeyPress() {
               switch currentState {
               case .idle:
                   currentState = .recording
               case .recording:
                   currentState = .processing
                   // Simulate processing completion (will be replaced with real transcription in Phase 2)
                   Task {
                       try? await Task.sleep(for: .seconds(1))
                       await MainActor.run {
                           self.currentState = .idle
                       }
                   }
               case .processing:
                   // Ignore hotkey while processing
                   break
               }
           }

           var menuBarIcon: String {
               switch currentState {
               case .idle: return "mic.circle"
               case .recording: return "mic.circle.fill"
               case .processing: return "waveform.circle"
               }
           }
       }
       ```

    The handleHotkeyPress implements toggle mode behavior: idle→recording→processing→idle.
    The 1-second delay simulates transcription processing (placeholder for Phase 2).
  </action>
  <verify>
    cd /Users/connecteddale/Library/CloudStorage/Dropbox/portfolio-life/Python/option-c && swift build

    # Verify KeyboardShortcuts import works
    grep -q "import KeyboardShortcuts" Sources/OptionC/State/AppState.swift && echo "Import found"
    grep -q "toggleRecording" Sources/OptionC/KeyboardShortcuts+Names.swift && echo "Shortcut name defined"
  </verify>
  <done>
    - KeyboardShortcuts+Names.swift defines toggleRecording with Option-C default
    - AppState.init() registers onKeyUp handler
    - handleHotkeyPress() implements state machine: idle→recording→processing→idle
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Menu Content View</name>
  <files>
    Sources/OptionC/Views/MenuBarView.swift
    Sources/OptionC/OptionCApp.swift
  </files>
  <action>
    Create the menu dropdown content with mode picker and quit button:

    1. **Sources/OptionC/Views/MenuBarView.swift**: Create menu view:
       ```swift
       import SwiftUI

       struct MenuBarView: View {
           @ObservedObject var appState: AppState

           var body: some View {
               VStack(alignment: .leading, spacing: 12) {
                   // Status indicator
                   HStack {
                       Image(systemName: appState.menuBarIcon)
                       Text(appState.currentState.displayName)
                   }
                   .font(.headline)

                   Divider()

                   // Recording mode section
                   Text("Recording Mode")
                       .font(.subheadline)
                       .foregroundColor(.secondary)

                   Picker("", selection: $appState.recordingMode) {
                       Text("Toggle (press to start/stop)").tag(RecordingMode.toggle)
                       Text("Push-to-Talk (hold to record)").tag(RecordingMode.pushToTalk)
                   }
                   .pickerStyle(.radioGroup)
                   .labelsHidden()

                   Divider()

                   // Quit button
                   Button("Quit Option-C") {
                       NSApplication.shared.terminate(nil)
                   }
                   .keyboardShortcut("q")
               }
               .padding()
               .frame(width: 280)
           }
       }
       ```

    2. **Sources/OptionC/Models/RecordingState.swift**: Add displayName computed property:
       ```swift
       enum RecordingState {
           case idle
           case recording
           case processing

           var displayName: String {
               switch self {
               case .idle: return "Ready"
               case .recording: return "Recording..."
               case .processing: return "Processing..."
               }
           }
       }
       ```

    3. **Sources/OptionC/OptionCApp.swift**: Update to use MenuBarView:
       ```swift
       import SwiftUI

       @main
       struct OptionCApp: App {
           @StateObject private var appState = AppState()

           var body: some Scene {
               MenuBarExtra {
                   MenuBarView(appState: appState)
               } label: {
                   Image(systemName: appState.menuBarIcon)
               }
           }
       }
       ```

    This implements MENU-04 (mode display), MENU-05 (quit), and CORE-04 (mode switching).
  </action>
  <verify>
    cd /Users/connecteddale/Library/CloudStorage/Dropbox/portfolio-life/Python/option-c && swift build

    # Verify menu view exists and has required elements
    grep -q "RecordingMode" Sources/OptionC/Views/MenuBarView.swift && echo "Mode picker present"
    grep -q "Quit Option-C" Sources/OptionC/Views/MenuBarView.swift && echo "Quit button present"
    grep -q "MenuBarView" Sources/OptionC/OptionCApp.swift && echo "MenuBarView integrated"
  </verify>
  <done>
    - MenuBarView.swift created with mode picker and quit button
    - RecordingState has displayName property
    - OptionCApp uses MenuBarView in MenuBarExtra content
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Final Build and Verification</name>
  <files>None (verification only)</files>
  <action>
    Perform final verification of all Phase 1 functionality:

    1. Clean build: swift package clean && swift build -c release
    2. Verify all source files present
    3. Verify all imports resolve correctly
    4. Check for compiler warnings that indicate issues

    Expected behavior when run manually:
    - Menu bar shows mic.circle icon
    - Clicking icon opens menu with mode picker and quit button
    - Pressing Option-C cycles: mic.circle → mic.circle.fill → waveform.circle → mic.circle
    - Mode picker persists selection across app restarts
    - Quit button terminates app
  </action>
  <verify>
    cd /Users/connecteddale/Library/CloudStorage/Dropbox/portfolio-life/Python/option-c

    # Clean and rebuild
    swift package clean
    swift build -c release

    # Verify binary
    ls -la .build/release/OptionC
    file .build/release/OptionC

    # Verify all source files exist
    echo "=== Source files ==="
    find Sources -name "*.swift" -type f | sort

    # Verify key patterns in code
    echo "=== Key patterns ==="
    grep -l "MenuBarExtra" Sources/OptionC/*.swift
    grep -l "@MainActor" Sources/OptionC/**/*.swift
    grep -l "KeyboardShortcuts" Sources/OptionC/**/*.swift
  </verify>
  <done>
    - Release build succeeds without errors
    - All source files present: OptionCApp.swift, AppState.swift, MenuBarView.swift, RecordingMode.swift, RecordingState.swift, KeyboardShortcuts+Names.swift
    - Binary produced at .build/release/OptionC
    - All key patterns verified in source
  </done>
</task>

</tasks>

<verification>
Phase 1 Plan 02 verification checklist:

1. Hotkey integration:
   - [ ] KeyboardShortcuts+Names.swift exists
   - [ ] toggleRecording defined with Option-C default
   - [ ] AppState registers onKeyUp handler
   - [ ] State machine: idle→recording→processing→idle

2. Menu content:
   - [ ] MenuBarView.swift exists
   - [ ] Mode picker with toggle and push-to-talk options
   - [ ] Quit button present
   - [ ] Status display shows current state

3. Integration:
   - [ ] OptionCApp uses MenuBarView
   - [ ] AppState injected via @StateObject
   - [ ] Build succeeds without errors
</verification>

<success_criteria>
- Option-C hotkey registered and triggers state changes
- Menu shows current mode (toggle vs push-to-talk)
- Mode can be changed via radio picker
- Mode persists via @AppStorage
- Quit button terminates app
- Icon changes based on state: mic.circle (idle), mic.circle.fill (recording), waveform.circle (processing)
- Release build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-menu-bar/01-02-SUMMARY.md`
</output>
