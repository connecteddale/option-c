---
phase: 03-feedback-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - OptionC/Models/AppError.swift
  - OptionC/Services/PermissionManager.swift
autonomous: true

must_haves:
  truths:
    - "User sees clear message if microphone permission is missing"
    - "User sees clear message if speech recognition permission is missing"
    - "Permission denials provide actionable recovery guidance"
  artifacts:
    - path: "OptionC/Models/AppError.swift"
      provides: "Centralized error types with user-friendly messages"
      exports: ["AppError"]
      contains: "LocalizedError"
    - path: "OptionC/Services/PermissionManager.swift"
      provides: "Permission checking and requesting"
      exports: ["PermissionManager"]
      contains: "AVCaptureDevice.authorizationStatus"
  key_links:
    - from: "OptionC/Models/AppError.swift"
      to: "LocalizedError protocol"
      via: "protocol conformance"
      pattern: "errorDescription.*recoverySuggestion"
    - from: "OptionC/Services/PermissionManager.swift"
      to: "AVCaptureDevice"
      via: "authorization check"
      pattern: "AVCaptureDevice\\.authorizationStatus"
---

<objective>
Create the error type system and permission manager for graceful handling of permission denials and operation failures.

Purpose: Users need clear, actionable feedback when permissions are missing or operations fail. This plan establishes the error infrastructure that the notification system and state coordinator will consume.

Output: AppError enum with LocalizedError conformance and PermissionManager class for checking/requesting microphone and speech recognition permissions.
</objective>

<execution_context>
@/Users/connecteddale/.claude/get-shit-done/workflows/execute-plan.md
@/Users/connecteddale/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-feedback-error-handling/03-RESEARCH.md

Key patterns from research:
- AppError enum with LocalizedError protocol for errorDescription and recoverySuggestion
- AVCaptureDevice.authorizationStatus(for: .audio) for microphone permission
- SFSpeechRecognizer.authorizationStatus() for speech recognition permission
- Async permission requests with withCheckedContinuation for SFSpeechRecognizer
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppError enum with LocalizedError conformance</name>
  <files>OptionC/Models/AppError.swift</files>
  <action>
Create AppError enum at OptionC/Models/AppError.swift with the following cases:
- microphonePermissionDenied
- speechRecognitionPermissionDenied
- noSpeechDetected
- transcriptionTimeout
- recordingFailed(underlying: Error)
- clipboardWriteFailed

Conform to LocalizedError protocol with:
- errorDescription: User-facing error title (e.g., "Microphone access required")
- recoverySuggestion: Actionable guidance (e.g., "Enable microphone access in System Settings > Privacy & Security > Microphone")

Use switch statements for both properties. Keep messages concise but informative.

Import Foundation only.
  </action>
  <verify>
- File exists at OptionC/Models/AppError.swift
- Build succeeds: `xcodebuild -project OptionC.xcodeproj -scheme OptionC -destination 'platform=macOS' build 2>&1 | grep -E "(error:|warning:|BUILD SUCCEEDED|BUILD FAILED)"`
- AppError conforms to LocalizedError (has errorDescription and recoverySuggestion)
  </verify>
  <done>
AppError enum exists with all six error cases, each providing user-friendly errorDescription and actionable recoverySuggestion strings. No build errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PermissionManager for microphone and speech permissions</name>
  <files>OptionC/Services/PermissionManager.swift</files>
  <action>
Create PermissionManager class at OptionC/Services/PermissionManager.swift with @MainActor isolation.

Include PermissionStatus enum with cases: granted, denied, notDetermined, restricted

Implement methods:

1. checkMicrophonePermission() -> PermissionStatus
   - Use AVCaptureDevice.authorizationStatus(for: .audio)
   - Map .authorized -> .granted, .denied -> .denied, etc.
   - Handle @unknown default as .denied

2. requestMicrophonePermission() async -> Result<Void, AppError>
   - Check current status first
   - If .granted, return .success(())
   - If .denied or .restricted, return .failure(.microphonePermissionDenied)
   - If .notDetermined, await AVCaptureDevice.requestAccess(for: .audio)
   - Return .success(()) or .failure(.microphonePermissionDenied) based on result

3. checkSpeechRecognitionPermission() -> PermissionStatus
   - Use SFSpeechRecognizer.authorizationStatus()
   - Same mapping as microphone

4. requestSpeechRecognitionPermission() async -> Result<Void, AppError>
   - Check current status first
   - If .granted, return .success(())
   - If .denied or .restricted, return .failure(.speechRecognitionPermissionDenied)
   - If .notDetermined, use withCheckedContinuation to wrap SFSpeechRecognizer.requestAuthorization
   - IMPORTANT: Resume continuation exactly ONCE in all code paths to avoid crashes

Import AVFoundation and Speech frameworks.
  </action>
  <verify>
- File exists at OptionC/Services/PermissionManager.swift
- Build succeeds: `xcodebuild -project OptionC.xcodeproj -scheme OptionC -destination 'platform=macOS' build 2>&1 | grep -E "(error:|warning:|BUILD SUCCEEDED|BUILD FAILED)"`
- PermissionManager has all four methods
- Uses @MainActor isolation
  </verify>
  <done>
PermissionManager exists with checkMicrophonePermission, requestMicrophonePermission, checkSpeechRecognitionPermission, and requestSpeechRecognitionPermission methods. Properly handles all authorization states. Uses @MainActor for thread safety. No build errors.
  </done>
</task>

</tasks>

<verification>
1. Both files exist and compile without errors
2. AppError provides meaningful errorDescription for all cases
3. AppError provides actionable recoverySuggestion for all cases
4. PermissionManager correctly maps all AVCaptureDevice and SFSpeechRecognizer authorization states
5. Async permission requests use proper continuation handling (single resume)
</verification>

<success_criteria>
- AppError enum with 6 error cases conforming to LocalizedError
- PermissionManager with 4 methods for checking/requesting both permission types
- Clean build with no errors or warnings related to these files
- Ready for integration with NotificationManager (Plan 02) and StateCoordinator (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/03-feedback-error-handling/03-01-SUMMARY.md`
</output>
